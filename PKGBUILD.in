# Original Author: Siddhartha Chaudhuri
# Maintainer: Rodrigo Hernandez

# Detect MSYS2 environment
if [[ -n "$MSYSTEM" ]]; then
    _msys2=true
    _mingw_prefix="${MINGW_PREFIX:-/mingw64}"
    _pkgprefix="mingw-w64-${MSYSTEM_CARCH}-"
else
    _msys2=false
    _mingw_prefix=""
    _pkgprefix=""
fi

pkgbase=${_pkgprefix}thea
pkgname=("${_pkgprefix}thea" "${_pkgprefix}thea-debug")
pkgver=@PACKAGE_VERSION@
pkgrel=1
pkgdesc="A toolkit for visual computing with a focus on geometry processing"
arch=('x86_64')
url="https://github.com/Kwizatz/Thea.git"
license=('BSD')

if [[ "$_msys2" == true ]]; then
    # MSYS2 dependencies
    makedepends=(
        "${MINGW_PACKAGE_PREFIX}-cmake"
        "${MINGW_PACKAGE_PREFIX}-gcc"
        "${MINGW_PACKAGE_PREFIX}-make"
        "${MINGW_PACKAGE_PREFIX}-eigen3"
        "${MINGW_PACKAGE_PREFIX}-cgal"
        "${MINGW_PACKAGE_PREFIX}-boost"
        "${MINGW_PACKAGE_PREFIX}-gmp"
        "${MINGW_PACKAGE_PREFIX}-mpfr"
        "${MINGW_PACKAGE_PREFIX}-wxwidgets3.2-msw"
        "${MINGW_PACKAGE_PREFIX}-opencl-headers"
        "${MINGW_PACKAGE_PREFIX}-opencl-icd"
        'git'
    )
    depends=(
        "${MINGW_PACKAGE_PREFIX}-eigen3"
        "${MINGW_PACKAGE_PREFIX}-gcc-libs"
    )
    optdepends=(
        "${MINGW_PACKAGE_PREFIX}-cgal: Additional computational geometry algorithms"
        "${MINGW_PACKAGE_PREFIX}-wxwidgets3.2-msw: GUI tools support"
    )
else
    # Arch Linux dependencies
    makedepends=(
        'cmake'
        'gcc'
        'make'
        'eigen'
        'cgal'
        'boost'
        'gmp'
        'mpfr'
        'mesa'
        'glu'
        'libgl'
        'wxwidgets-gtk3'
        'opencl-headers'
        'ocl-icd'
        'git'
    )
    depends=(
        'eigen'
    )
    optdepends=(
        'cgal: Additional computational geometry algorithms'
        'mesa: OpenGL plugin support'
        'wxwidgets-gtk3: GUI tools support'
    )
fi

# Use local source - no remote fetching
source=()
sha256sums=()

# Build options
_with_tools=ON
_with_tests=OFF

# Get the directory where the PKGBUILD is located (the repo root)
_srcroot="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

prepare() {
    # Create build directories in the source directory
    mkdir -p "$_srcroot/build-release"
    mkdir -p "$_srcroot/build-debug"
}

_build_common() {
    local build_type=$1
    local build_dir=$2
    
    cd "$_srcroot/$build_dir"
    
    # Platform-specific settings
    if [[ "$_msys2" == true ]]; then
        local _install_prefix="$_mingw_prefix"
        local _eigen_include="$_mingw_prefix/include/eigen3"
        local _generator="MinGW Makefiles"
        local _make_cmd="mingw32-make"
        local _gl_plugin=OFF  # OpenGL plugin may not work well on MSYS2
        # Prevent MSYS2 from converting the install prefix path to Windows format
        export MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX="
    else
        local _install_prefix="/usr"
        local _eigen_include="/usr/include/eigen3"
        local _generator="Unix Makefiles"
        local _make_cmd="make"
        local _gl_plugin=ON
    fi
    
    cmake "$_srcroot/Code/Build" \
        -G "$_generator" \
        -DCMAKE_BUILD_TYPE=$build_type \
        -DCMAKE_INSTALL_PREFIX="$_install_prefix" \
        -DTHEA_DEPS_ROOT="$_install_prefix" \
        -DEIGEN3_INCLUDE_DIR="$_eigen_include" \
        -DWITH_PLUGIN_ARPACK=OFF \
        -DWITH_PLUGIN_CSPARSE=OFF \
        -DWITH_PLUGIN_GL=$_gl_plugin \
        -DWITH_TOOLS=${_with_tools} \
        -DWITH_TESTS=${_with_tests} \
        -DWITH_CGAL=ON \
        -DWITH_FREEIMAGE=OFF \
        -DWITH_LIB3DS=OFF \
        -DWITH_CLUTO=OFF \
        -DLITE=OFF
    
    $_make_cmd -j$(nproc)
}

build() {
    # Build Release version
    _build_common "Release" "build-release"
    
    # Build Debug version
    _build_common "Debug" "build-debug"
}

check() {
    if [[ "${_with_tests}" == "ON" ]]; then
        cd "$_srcroot/build-release"
        if [[ "$_msys2" == true ]]; then
            mingw32-make test || true
        else
            make test || true
        fi
    fi
}

# Get the install prefix based on platform
_get_prefix() {
    if [[ "$_msys2" == true ]]; then
        echo "$_mingw_prefix"
    else
        echo "/usr"
    fi
}

# Dynamic package function for thea (Release)
eval "package_${_pkgprefix}thea() {
    pkgdesc=\"A toolkit for visual computing with a focus on geometry processing (Release)\"
    local _prefix=\$(_get_prefix)
    
    cd \"\$_srcroot/build-release\"
    
    # Use CMake install target with DESTDIR
    if [[ \"\$_msys2\" == true ]]; then
        mingw32-make DESTDIR=\"\$pkgdir\" install
    else
        make DESTDIR=\"\$pkgdir\" install
    fi
    
    # Install license
    install -Dm644 \"\$_srcroot/LICENSE.txt\" \"\$pkgdir\${_prefix}/share/licenses/\${pkgname}/LICENSE\"
    
    # Install documentation
    install -Dm644 \"\$_srcroot/README.md\" \"\$pkgdir\${_prefix}/share/doc/\${pkgname}/README.md\"
}"

# Dynamic package function for thea-debug
eval "package_${_pkgprefix}thea-debug() {
    pkgdesc=\"A toolkit for visual computing with a focus on geometry processing (Debug)\"
    depends=(\"${_pkgprefix}thea\")
    local _prefix=\$(_get_prefix)
    
    cd \"\$_srcroot/build-debug\"
    
    # Use CMake install target with DESTDIR
    if [[ \"\$_msys2\" == true ]]; then
        mingw32-make DESTDIR=\"\$pkgdir\" install
    else
        make DESTDIR=\"\$pkgdir\" install
    fi
    
    # Remove duplicate files that are already in the release package
    # Keep only debug libraries (with 'd' suffix) and debug-specific CMake config
    
    # Remove headers (already installed by release package)
    rm -rf \"\$pkgdir\${_prefix}/include\"
    
    # Remove non-debug libraries
    find \"\$pkgdir\${_prefix}/lib\" -name \"*.a\" ! -name \"*d.a\" -delete 2>/dev/null || true
    
    # Remove tools/binaries (already installed by release package)
    rm -rf \"\$pkgdir\${_prefix}/bin\"
    rm -rf \"\$pkgdir\${_prefix}/share/Thea\"
    
    # Keep the CMake config for debug but it will reference the release package's headers
    # The TheaTargets.cmake will have proper debug configuration
    
    # Install license
    install -Dm644 \"\$_srcroot/LICENSE.txt\" \"\$pkgdir\${_prefix}/share/licenses/\${pkgname}/LICENSE\"
}"
